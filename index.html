<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Scorer - Tournament Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .modal { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        /* Prevent double-tap zoom on mobile */
        button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans select-none">

    <div id="homeScreen" class="container mx-auto p-4 max-w-md">
        <div class="bg-white rounded-2xl shadow-xl p-8 mt-10 text-center">
            <div class="text-6xl mb-4">üèÜ</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Cricket Scorer</h1>
            <p class="text-gray-500 mb-8">Tournament Pro Edition</p>
            <button onclick="showSetup()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow transition transform active:scale-95">
                Start New Match
            </button>
            <p class="text-xs text-gray-400 mt-8">Includes Undo, Maidens & Win Logic</p>
        </div>
    </div>

    <div id="setupScreen" class="container mx-auto p-4 max-w-md hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <button onclick="showHome()" class="text-gray-500 mb-4 hover:text-gray-800">‚Üê Back</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Match Setup</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-gray-700">Team Batting 1st</label>
                    <input type="text" id="team1Name" class="w-full mt-1 p-3 border rounded-lg bg-gray-50" placeholder="e.g. CSK">
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-700">Team Bowling 1st</label>
                    <input type="text" id="team2Name" class="w-full mt-1 p-3 border rounded-lg bg-gray-50" placeholder="e.g. MI">
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-700">Overs</label>
                    <div class="flex items-center gap-3 mt-1">
                        <button onclick="adjustValue('overs', -1)" class="bg-gray-200 w-10 h-10 rounded-lg font-bold">-</button>
                        <input type="number" id="overs" value="5" class="w-20 text-center p-2 border rounded-lg" readonly>
                        <button onclick="adjustValue('overs', 1)" class="bg-gray-200 w-10 h-10 rounded-lg font-bold">+</button>
                    </div>
                </div>
                <button onclick="startMatch()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl mt-4 shadow">Start Match</button>
            </div>
        </div>
    </div>

    <div id="scoringScreen" class="container mx-auto p-2 md:p-4 hidden max-w-3xl">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-3">
            <div class="flex justify-between items-center border-b pb-2 mb-2">
                <div>
                    <h2 class="font-bold text-lg text-gray-800" id="matchHeader">Team A vs Team B</h2>
                    <p class="text-xs text-blue-600 font-bold" id="inningsHeader">1st Innings</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="undoLastBall()" id="undoBtn" class="text-gray-600 text-xs font-bold border border-gray-300 px-3 py-1 rounded hover:bg-gray-100 disabled:opacity-50">‚Ü© UNDO</button>
                    <button onclick="if(confirm('Quit Match?')) showHome()" class="text-red-500 text-xs font-bold border border-red-100 px-2 py-1 rounded">EXIT</button>
                </div>
            </div>
            
            <div class="flex justify-between items-center bg-gray-900 rounded-lg p-4 text-white relative overflow-hidden">
                <div>
                    <div class="text-4xl font-bold tracking-tight" id="mainScore">0/0</div>
                    <div class="text-sm text-gray-400" id="mainOvers">0.0 Overs</div>
                </div>
                <div class="text-right z-10">
                    <div class="text-xl font-semibold text-yellow-400" id="runRate">CRR: 0.00</div>
                    <div class="text-xs text-gray-300 mt-1 font-bold" id="targetDisplay"></div>
                    <div class="text-xs text-green-400 mt-1" id="reqRunRate"></div>
                </div>
            </div>
            <div id="matchStatusMessage" class="hidden mt-2 p-2 bg-green-100 text-green-800 text-center font-bold rounded text-sm"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <div class="bg-white rounded-xl shadow p-3">
                <div class="flex justify-between items-center mb-2 border-b pb-1">
                    <span class="text-xs font-bold text-gray-500 uppercase">Batting</span>
                    <span class="text-xs text-green-600 font-bold">Strike</span>
                </div>
                <div onclick="swapStrike()" class="flex justify-between items-center p-2 rounded cursor-pointer hover:bg-gray-50 transition" id="strikerRow">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500" id="strikerDot"></div>
                        <input type="text" id="bat1Name" class="font-bold text-gray-800 w-32 bg-transparent outline-none text-sm" readonly>
                    </div>
                    <div class="font-mono text-gray-700 text-sm" id="bat1Score">0(0)</div>
                </div>
                <div onclick="swapStrike()" class="flex justify-between items-center p-2 rounded cursor-pointer hover:bg-gray-50 transition" id="nonStrikerRow">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-gray-300" id="nonStrikerDot"></div>
                        <input type="text" id="bat2Name" class="font-bold text-gray-800 w-32 bg-transparent outline-none text-sm" readonly>
                    </div>
                    <div class="font-mono text-gray-700 text-sm" id="bat2Score">0(0)</div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-3">
                <div class="flex justify-between items-center mb-2 border-b pb-1">
                    <span class="text-xs font-bold text-gray-500 uppercase">Bowling</span>
                </div>
                <div class="flex justify-between items-center p-2">
                    <input type="text" id="bowlerName" class="font-bold text-gray-800 w-32 bg-transparent outline-none text-sm" readonly>
                    <div class="font-mono text-gray-700 text-sm" id="bowlerScore">0-0 (0.0)</div>
                </div>
                <div class="mt-2 flex gap-1 overflow-x-auto pb-1" id="ballsContainer" style="min-height: 2rem;"></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-4 mb-4" id="keypad">
            <div class="grid grid-cols-4 gap-2 mb-2">
                <button onclick="processRun(0)" class="btn-score bg-gray-100 text-gray-700">0</button>
                <button onclick="processRun(1)" class="btn-score bg-gray-100 text-gray-700">1</button>
                <button onclick="processRun(2)" class="btn-score bg-gray-100 text-gray-700">2</button>
                <button onclick="processRun(3)" class="btn-score bg-gray-100 text-gray-700">3</button>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-2">
                <button onclick="processRun(4)" class="btn-score bg-green-100 text-green-700 font-bold border border-green-200">4</button>
                <button onclick="processRun(6)" class="btn-score bg-purple-100 text-purple-700 font-bold border border-purple-200">6</button>
                <button onclick="openWicketModal()" class="btn-score col-span-2 bg-red-500 text-white font-bold hover:bg-red-600">OUT</button>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <button onclick="openExtraModal('wide')" class="btn-extra bg-orange-50 text-orange-600 text-xs font-bold py-3 rounded border border-orange-100">WIDE</button>
                <button onclick="openExtraModal('noball')" class="btn-extra bg-orange-50 text-orange-600 text-xs font-bold py-3 rounded border border-orange-100">NO BALL</button>
                <button onclick="openExtraModal('bye')" class="btn-extra bg-yellow-50 text-yellow-600 text-xs font-bold py-3 rounded border border-yellow-100">BYE</button>
                <button onclick="openExtraModal('legbye')" class="btn-extra bg-yellow-50 text-yellow-600 text-xs font-bold py-3 rounded border border-yellow-100">LB</button>
            </div>
        </div>

        <div id="gameControlPanel" class="hidden mb-4 space-y-2">
             <button onclick="startSecondInnings()" id="btnStartInnings2" class="hidden w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow animate-pulse">Start 2nd Innings</button>
             <button onclick="showHome()" id="btnNewMatch" class="hidden w-full bg-gray-800 text-white font-bold py-3 rounded-xl shadow">Start New Match</button>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <h3 class="font-bold text-gray-700 mb-3 border-b pb-2">Scorecard</h3>
            <div id="fullScorecard" class="text-sm"></div>
        </div>
    </div>

    <div id="extraModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm modal">
            <h3 class="text-xl font-bold mb-4" id="extraModalTitle">Extra</h3>
            <p class="text-sm text-gray-600 mb-3">Runs scored on this ball (excluding the extra)?</p>
            <div class="grid grid-cols-5 gap-2 mb-6">
                <button onclick="selectExtraRuns(0)" class="p-3 rounded bg-gray-100 hover:bg-blue-100 font-bold extra-opt">0</button>
                <button onclick="selectExtraRuns(1)" class="p-3 rounded bg-gray-100 hover:bg-blue-100 font-bold extra-opt">1</button>
                <button onclick="selectExtraRuns(2)" class="p-3 rounded bg-gray-100 hover:bg-blue-100 font-bold extra-opt">2</button>
                <button onclick="selectExtraRuns(3)" class="p-3 rounded bg-gray-100 hover:bg-blue-100 font-bold extra-opt">3</button>
                <button onclick="selectExtraRuns(4)" class="p-3 rounded bg-gray-100 hover:bg-blue-100 font-bold extra-opt">4</button>
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal('extraModal')" class="flex-1 py-3 bg-gray-200 rounded-lg font-bold">Cancel</button>
                <button onclick="confirmExtra()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold">Confirm</button>
            </div>
        </div>
    </div>

    <div id="wicketModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm modal overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-red-600">Wicket Fall</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Dismissal Type</label>
                    <select id="wicketType" class="w-full p-2 border rounded bg-gray-50">
                        <option value="Caught">Caught</option>
                        <option value="Bowled">Bowled</option>
                        <option value="LBW">LBW</option>
                        <option value="Run Out">Run Out</option>
                        <option value="Stumped">Stumped</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Who is Out?</label>
                    <div class="flex gap-2">
                        <button onclick="setWicketVictim('striker')" id="btnWicStriker" class="flex-1 p-2 border rounded bg-red-100 border-red-500 font-bold text-red-700">Striker</button>
                        <button onclick="setWicketVictim('nonstriker')" id="btnWicNonStriker" class="flex-1 p-2 border rounded bg-gray-100 text-gray-600">Non-Striker</button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Runs Scored (Run Out only)</label>
                    <input type="number" id="wicketRuns" value="0" min="0" class="w-full p-2 border rounded text-center font-bold text-lg">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal('wicketModal')" class="flex-1 py-3 bg-gray-200 rounded-lg font-bold">Cancel</button>
                <button onclick="confirmWicket()" class="flex-1 py-3 bg-red-600 text-white rounded-lg font-bold">Confirm OUT</button>
            </div>
        </div>
    </div>

    <div id="overModal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm modal text-center">
            <h3 class="text-2xl font-bold mb-2">End of Over</h3>
            <div class="bg-gray-100 p-4 rounded-xl mb-4">
                <div class="text-sm text-gray-500 uppercase">Runs Conceded</div>
                <div class="text-3xl font-bold text-gray-800" id="overSummaryRuns">0</div>
                <div class="text-sm text-gray-500 mt-2" id="maidenStatus"></div>
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1 text-left">Next Bowler Name</label>
                <input type="text" id="nextBowlerName" class="w-full p-3 border rounded-lg" placeholder="Enter Name">
            </div>
            <button onclick="confirmOverEnd()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold">Start Next Over</button>
        </div>
    </div>

    <script>
        // --- Game State ---
        let game = {};
        let historyStack = []; // For Undo functionality

        // Temp vars
        let tempExtraType = '';
        let tempExtraRuns = 0;
        let wicketVictim = 'striker'; 

        // --- Navigation ---
        function adjustValue(id, delta) {
            const el = document.getElementById(id);
            let val = parseInt(el.value) + delta;
            if (val < 1) val = 1;
            el.value = val;
        }

        function showSetup() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
        }

        function showHome() {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('scoringScreen').classList.add('hidden');
            document.getElementById('homeScreen').classList.remove('hidden');
        }

        // --- Initialization ---
        function startMatch() {
            const t1 = document.getElementById('team1Name').value || "Team A";
            const t2 = document.getElementById('team2Name').value || "Team B";
            const overs = parseInt(document.getElementById('overs').value);
            
            // Initialize fresh state
            game = {
                team1: t1, team2: t2, totalOvers: overs,
                innings: 1, 
                battingTeam: t1, bowlingTeam: t2,
                score: 0, wickets: 0, balls: 0, extras: 0,
                target: null,
                isMatchOver: false,
                striker: { name: "Batter 1", runs: 0, balls: 0, fours: 0, sixes: 0 },
                nonStriker: { name: "Batter 2", runs: 0, balls: 0, fours: 0, sixes: 0 },
                bowler: { name: "Bowler 1", runs: 0, balls: 0, wickets: 0, maidens: 0 },
                batsmenList: [],
                bowlersList: [],
                thisOver: [], // {runs, label, isWide, isNoBall, isBowlerRun}
            };
            
            historyStack = [];
            
            // UI Prompts for names
            game.striker.name = prompt("Enter Striker Name:", "Batter 1") || "Batter 1";
            game.nonStriker.name = prompt("Enter Non-Striker Name:", "Batter 2") || "Batter 2";
            game.bowler.name = prompt("Enter Opening Bowler:", "Bowler 1") || "Bowler 1";

            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('scoringScreen').classList.remove('hidden');
            document.getElementById('gameControlPanel').classList.add('hidden');
            document.getElementById('keypad').classList.remove('hidden');
            updateUI();
        }

        // --- Undo Logic ---
        function saveState() {
            // Deep copy game state
            historyStack.push(JSON.stringify(game));
            if(historyStack.length > 50) historyStack.shift(); // Limit history
            document.getElementById('undoBtn').disabled = false;
        }

        function undoLastBall() {
            if(historyStack.length === 0) return;
            const prevState = historyStack.pop();
            game = JSON.parse(prevState);
            updateUI();
            if(historyStack.length === 0) document.getElementById('undoBtn').disabled = true;
        }

        // --- Core Scoring ---
        function processRun(runs) {
            if(game.isMatchOver) return;
            saveState();

            // Stats
            game.score += runs;
            game.striker.runs += runs;
            game.striker.balls++;
            game.bowler.runs += runs;
            game.bowler.balls++; // Legal ball
            game.balls++;
            
            if(runs === 4) game.striker.fours++;
            if(runs === 6) game.striker.sixes++;

            if(runs % 2 !== 0) swapStrike(false);

            game.thisOver.push({ val: runs, label: runs, isBowlerRun: true });
            
            checkGameEvents();
        }

        // --- Wicket Logic ---
        function openWicketModal() {
            if(game.isMatchOver) return;
            wicketVictim = 'striker';
            setWicketVictim('striker');
            document.getElementById('wicketRuns').value = 0;
            document.getElementById('wicketModal').classList.remove('hidden');
        }

        function setWicketVictim(who) {
            wicketVictim = who;
            const btnS = document.getElementById('btnWicStriker');
            const btnNs = document.getElementById('btnWicNonStriker');
            
            if (who === 'striker') {
                btnS.className = "flex-1 p-2 border rounded bg-red-100 border-red-500 font-bold text-red-700 transition";
                btnNs.className = "flex-1 p-2 border rounded bg-gray-50 text-gray-400 transition";
            } else {
                btnNs.className = "flex-1 p-2 border rounded bg-red-100 border-red-500 font-bold text-red-700 transition";
                btnS.className = "flex-1 p-2 border rounded bg-gray-50 text-gray-400 transition";
            }
        }

        function confirmWicket() {
            saveState();
            const type = document.getElementById('wicketType').value;
            const extraRuns = parseInt(document.getElementById('wicketRuns').value) || 0;
            
            game.score += extraRuns;
            game.bowler.runs += extraRuns;
            game.balls++;
            game.bowler.balls++;

            // Handle Victim
            const victim = (wicketVictim === 'striker') ? game.striker : game.nonStriker;
            victim.runs += extraRuns;
            victim.balls++;
            victim.howOut = `${type} b ${game.bowler.name}`;
            
            game.batsmenList.push({...victim}); // Archive
            game.wickets++;
            if(type !== "Run Out") game.bowler.wickets++;

            game.thisOver.push({ val: 'W', label: 'W', isBowlerRun: (extraRuns > 0) });

            // New Batter
            const newName = prompt("Enter New Batsman Name:", "New Batter") || "New Batter";
            const newPlayer = { name: newName, runs: 0, balls: 0, fours: 0, sixes: 0 };

            if(wicketVictim === 'striker') game.striker = newPlayer;
            else game.nonStriker = newPlayer;

            // Logic: New batsman always takes strike if Caught/Bowled (Modern rule), 
            // but for simplicity in local apps, we assume if 1 run was taken (run out) they crossed.
            // Keeping it simple: If odd runs on wicket, swap strike.
            if(extraRuns % 2 !== 0) swapStrike(false);

            closeModal('wicketModal');
            checkGameEvents();
        }

        // --- Extras Logic ---
        function openExtraModal(type) {
            if(game.isMatchOver) return;
            tempExtraType = type;
            document.getElementById('extraModalTitle').innerText = type.toUpperCase();
            selectExtraRuns(0);
            document.getElementById('extraModal').classList.remove('hidden');
        }

        function selectExtraRuns(n) {
            tempExtraRuns = n;
            document.querySelectorAll('.extra-opt').forEach((b, i) => {
                b.className = (i === n) ? "p-3 rounded bg-blue-600 text-white font-bold extra-opt" : "p-3 rounded bg-gray-100 hover:bg-blue-100 font-bold extra-opt";
            });
        }

        function confirmExtra() {
            saveState();
            const type = tempExtraType;
            const runs = tempExtraRuns;
            let total = 0;
            let label = "";

            if (type === 'wide') {
                total = 1 + runs;
                game.bowler.runs += total;
                game.extras += total;
                label = runs > 0 ? `Wd+${runs}` : `Wd`;
                game.thisOver.push({ val: label, label: label, isBowlerRun: true }); // Wides count against bowler
                if(runs % 2 !== 0) swapStrike(false);
            } 
            else if (type === 'noball') {
                total = 1 + runs;
                game.bowler.runs += total;
                game.extras += 1; // 1 NB run
                game.striker.runs += runs; // Runs off bat
                game.striker.balls++;
                label = runs > 0 ? `Nb+${runs}` : `Nb`;
                game.thisOver.push({ val: label, label: label, isBowlerRun: true });
                if(runs % 2 !== 0) swapStrike(false);
            }
            else { // Byes/Legbyes (Legal Ball)
                total = runs;
                game.score += runs;
                game.extras += runs;
                game.balls++;
                game.bowler.balls++;
                game.striker.balls++; // Faced ball
                label = type === 'bye' ? `B${runs}` : `Lb${runs}`;
                game.thisOver.push({ val: label, label: label, isBowlerRun: false }); // NOT bowler runs
                if(runs % 2 !== 0) swapStrike(false);
                checkGameEvents();
                closeModal('extraModal');
                updateUI();
                return;
            }

            game.score += total; // For wide/nb
            closeModal('extraModal');
            checkGameEvents(); // Check if match won on extra
            updateUI();
        }

        // --- Game Events (Over/Win/Switch) ---
        function checkGameEvents() {
            updateUI();

            // 1. Check Win
            if(game.target && game.score >= game.target) {
                endMatch(`${game.battingTeam} wins by ${10 - game.wickets} wickets!`);
                return;
            }

            // 2. Check All Out
            if(game.wickets >= 10) { // Assuming 11 players
                if(game.innings === 1) endInnings();
                else endMatch(`${game.bowlingTeam} wins by ${game.target - 1 - game.score} runs!`);
                return;
            }

            // 3. Check Over End (Legal balls)
            if(game.balls > 0 && game.balls % 6 === 0) {
                triggerOverEnd();
            }
        }

        function triggerOverEnd() {
            // Calc Runs Conceded by Bowler this over
            let bowlerRuns = 0;
            game.thisOver.forEach(b => {
                if(b.isBowlerRun) {
                    if(typeof b.val === 'number') bowlerRuns += b.val;
                    else if(b.label.includes('Wd') || b.label.includes('Nb')) {
                         // Extract number logic simplified for visual
                         bowlerRuns += 1; // Base extra
                         if(b.label.includes('+')) bowlerRuns += parseInt(b.label.split('+')[1]);
                    }
                    else if(b.label.includes('W') && b.label.includes('+')) {
                         bowlerRuns += parseInt(b.label.split('+')[1]);
                    }
                }
            });

            // Maiden Detection
            const isMaiden = (bowlerRuns === 0);
            if(isMaiden) game.bowler.maidens++;

            document.getElementById('overSummaryRuns').innerText = bowlerRuns;
            document.getElementById('maidenStatus').innerText = isMaiden ? "üéâ MAIDEN OVER! üéâ" : "";
            document.getElementById('nextBowlerName').value = "";
            document.getElementById('overModal').classList.remove('hidden');
            
            // Archive Bowler
            let existingBowler = game.bowlersList.find(b => b.name === game.bowler.name);
            if(existingBowler) {
                existingBowler.runs = game.bowler.runs;
                existingBowler.balls = game.bowler.balls;
                existingBowler.wickets = game.bowler.wickets;
                existingBowler.maidens = game.bowler.maidens;
            } else {
                game.bowlersList.push({...game.bowler});
            }
        }

        function confirmOverEnd() {
            const nextName = document.getElementById('nextBowlerName').value || "Next Bowler";
            game.thisOver = [];
            
            // Check Overs Limit
            if(game.balls / 6 >= game.totalOvers) {
                closeModal('overModal');
                if(game.innings === 1) endInnings();
                else {
                    if(game.score < game.target) endMatch(`${game.bowlingTeam} wins by ${game.target - 1 - game.score} runs!`);
                    else endMatch("Match Tied!");
                }
                return;
            }

            swapStrike(false); // End of over rotation
            game.bowler = { name: nextName, runs: 0, balls: 0, wickets: 0, maidens: 0 };
            
            // Check if bowler exists in history to restore stats
            const prevBowler = game.bowlersList.find(b => b.name === nextName);
            if(prevBowler) game.bowler = {...prevBowler};

            closeModal('overModal');
            updateUI();
        }

        function endInnings() {
            game.target = game.score + 1;
            document.getElementById('keypad').classList.add('hidden');
            document.getElementById('gameControlPanel').classList.remove('hidden');
            document.getElementById('btnStartInnings2').classList.remove('hidden');
            document.getElementById('btnNewMatch').classList.add('hidden');
            document.getElementById('matchStatusMessage').innerText = `Innings Break! Target: ${game.target}`;
            document.getElementById('matchStatusMessage').classList.remove('hidden');
        }

        function startSecondInnings() {
            // Archive Innings 1 data if needed (Skipped for simplicity, just swapping)
            game.innings = 2;
            const temp = game.battingTeam; game.battingTeam = game.bowlingTeam; game.bowlingTeam = temp;
            game.score = 0; game.wickets = 0; game.balls = 0; game.extras = 0;
            
            game.striker = { name: prompt("Striker:", "Batter 1"), runs: 0, balls: 0, fours: 0, sixes: 0 };
            game.nonStriker = { name: prompt("Non-Striker:", "Batter 2"), runs: 0, balls: 0, fours: 0, sixes: 0 };
            game.bowler = { name: prompt("Opening Bowler:", "Bowler 1"), runs: 0, balls: 0, wickets: 0, maidens: 0 };
            
            game.batsmenList = [];
            game.bowlersList = [];
            game.thisOver = [];
            historyStack = []; // Clear undo for new innings

            document.getElementById('keypad').classList.remove('hidden');
            document.getElementById('gameControlPanel').classList.add('hidden');
            document.getElementById('matchStatusMessage').classList.add('hidden');
            updateUI();
        }

        function endMatch(msg) {
            game.isMatchOver = true;
            document.getElementById('keypad').classList.add('hidden');
            document.getElementById('gameControlPanel').classList.remove('hidden');
            document.getElementById('btnStartInnings2').classList.add('hidden');
            document.getElementById('btnNewMatch').classList.remove('hidden');
            document.getElementById('matchStatusMessage').innerText = `üèÜ MATCH OVER: ${msg}`;
            document.getElementById('matchStatusMessage').classList.remove('hidden');
        }

        // --- Helpers ---
        function swapStrike(ui) {
            const temp = game.striker;
            game.striker = game.nonStriker;
            game.nonStriker = temp;
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- UI Update ---
        function updateUI() {
            // Headers
            document.getElementById('matchHeader').innerText = `${game.battingTeam} vs ${game.bowlingTeam}`;
            document.getElementById('inningsHeader').innerText = game.innings === 1 ? "1st Innings" : `Target: ${game.target}`;
            
            // Score
            document.getElementById('mainScore').innerText = `${game.score}/${game.wickets}`;
            document.getElementById('mainOvers').innerText = `${Math.floor(game.balls/6)}.${game.balls%6} / ${game.totalOvers} Ov`;
            
            const crr = game.balls > 0 ? (game.score / (game.balls/6)).toFixed(2) : "0.0";
            document.getElementById('runRate').innerText = `CRR: ${crr}`;

            // Target logic
            if(game.innings === 2) {
                const runsNeed = game.target - game.score;
                const ballsLeft = (game.totalOvers * 6) - game.balls;
                document.getElementById('targetDisplay').innerText = `Need ${runsNeed} off ${ballsLeft}`;
                const rrr = ballsLeft > 0 ? (runsNeed / (ballsLeft/6)).toFixed(2) : "-";
                document.getElementById('reqRunRate').innerText = `RRR: ${rrr}`;
            } else {
                document.getElementById('targetDisplay').innerText = "";
                document.getElementById('reqRunRate').innerText = "";
            }

            // Players
            document.getElementById('bat1Name').value = (game.striker.name.length > 10 ? game.striker.name.substring(0,10)+".." : game.striker.name) + "*";
            document.getElementById('bat1Score').innerText = `${game.striker.runs}(${game.striker.balls})`;
            
            document.getElementById('bat2Name').value = (game.nonStriker.name.length > 10 ? game.nonStriker.name.substring(0,10)+".." : game.nonStriker.name);
            document.getElementById('bat2Score').innerText = `${game.nonStriker.runs}(${game.nonStriker.balls})`;

            document.getElementById('bowlerName').value = game.bowler.name;
            document.getElementById('bowlerScore').innerText = `${game.bowler.wickets}-${game.bowler.runs} (${Math.floor(game.bowler.balls/6)}.${game.bowler.balls%6})`;

            // This Over
            const ballsDiv = document.getElementById('ballsContainer');
            ballsDiv.innerHTML = '';
            game.thisOver.forEach(b => {
                const s = document.createElement('span');
                s.className = "flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full text-xs font-bold border mx-0.5 " + getBallClass(b.label);
                s.innerText = b.label;
                ballsDiv.appendChild(s);
            });

            renderScorecard();
        }

        function getBallClass(lbl) {
            const str = String(lbl);
            if(str.includes('Wd') || str.includes('Nb')) return "bg-gray-700 text-white border-gray-800";
            if(str.includes('W')) return "bg-red-500 text-white border-red-600";
            if(str === '4') return "bg-green-500 text-white border-green-600";
            if(str === '6') return "bg-purple-600 text-white border-purple-700";
            return "bg-gray-200 text-gray-800 border-gray-300";
        }

        function renderScorecard() {
            const container = document.getElementById('fullScorecard');
            
            // Batting
            let allBat = [...game.batsmenList];
            allBat.push({...game.striker, status:'not out'});
            allBat.push({...game.nonStriker, status:'not out'});
            
            let html = `<table class="w-full text-xs mb-4"><thead class="bg-gray-100 font-bold"><tr><td class="p-2">Batter</td><td class="p-2">R(B)</td><td class="p-2">4/6</td></tr></thead><tbody>`;
            allBat.forEach(b => {
                html += `<tr class="border-b"><td class="p-2 ${b.status==='not out'?'text-green-700 font-bold':''}">${b.name} <span class="text-[10px] text-gray-500 block">${b.howOut||'not out'}</span></td><td class="p-2">${b.runs}(${b.balls})</td><td class="p-2">${b.fours}/${b.sixes}</td></tr>`;
            });
            html += `<tr><td class="p-2 font-bold">Extras</td><td colspan="2" class="p-2">${game.extras}</td></tr></tbody></table>`;

            // Bowling
            let allBowl = [...game.bowlersList];
            // Update current if in list, else add
            let currIdx = allBowl.findIndex(x => x.name === game.bowler.name);
            if(currIdx > -1) allBowl[currIdx] = game.bowler;
            else allBowl.push(game.bowler);

            html += `<table class="w-full text-xs"><thead class="bg-gray-100 font-bold"><tr><td class="p-2">Bowler</td><td class="p-2">O</td><td class="p-2">M</td><td class="p-2">R</td><td class="p-2">W</td></tr></thead><tbody>`;
            allBowl.forEach(b => {
                 html += `<tr class="border-b"><td class="p-2 font-bold">${b.name}</td><td class="p-2">${Math.floor(b.balls/6)}.${b.balls%6}</td><td class="p-2">${b.maidens}</td><td class="p-2">${b.runs}</td><td class="p-2 text-red-600 font-bold">${b.wickets}</td></tr>`;
            });
            html += `</tbody></table>`;
            
            container.innerHTML = html;
        }

    </script>
</body>
                            </html>
